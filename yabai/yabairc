#layer=above !/usr/bin/env sh

# load scripting additions
sudo yabai --load-sa
yabai -m signal --add event=dock_did_restart action="sudo yabai --load-sa"

# global settings
yabai -m config mouse_follows_focus          off
yabai -m config focus_follows_mouse          autofocus
yabai -m config window_placement             second_child
yabai -m config window_topmost               off
yabai -m config window_opacity               off
yabai -m config window_opacity_duration      0.0
yabai -m config window_shadow                float
yabai -m config active_window_opacity        1.0
yabai -m config normal_window_opacity        1.0
yabai -m config split_ratio                  0.50
yabai -m config auto_balance                 on
yabai -m config mouse_modifier               fn
yabai -m config mouse_action1                move
yabai -m config mouse_action2                resize
yabai -m config window_border on
yabai -m config window_border_width 6
yabai -m config active_window_border_color   0xff3d464d     
yabai -m config normal_window_border_color   0xff000000     


# general space settings
yabai -m config layout                       bsp
yabai -m config top_padding                  0
yabai -m config bottom_padding               0
yabai -m config left_padding                 0
yabai -m config right_padding                0
yabai -m config window_gap                   0

# keep these ones on top of all other windows
# yabai -m rule --add app="^zoom.*$" sticky=on layer=above manage=off
yabai -m rule --add app="^Finder$" sticky=on layer=above
yabai -m rule --add app="^Stickies$" sticky=on layer=above 
yabai -m rule --add app="^Command E$" sticky=on layer=above
yabai -m rule --add app="^Raycast$" sticky=on layer=above

# applications with custom rules (main, day-to-day applications/fullscreen
# applications that i want to stay behind floating windows)
applications="(Books|kitty|Figma|Google Chrome|Mighty|Cron|Linear|Obsidian|Beeper|Messages|Signal|Telegram|Notion|Preview|Terminal|QuickTime|Player|Spotify|Slack)"

# NOTE: you need to set the settings for the applications in the 
#       list first, or else they don't apply properly and you
#       can end up with some weird border/float/window behaviours

# main applications get set to bottom layer to prevent them from
# covering floating applications/popup windows
# yabai -m rule --add app="^${applications}$" manage=on layer=below

# any apps that aren't main applications get set to float
# e.g. system preferences, colour meter
yabai -m rule --add app!="^${applications}$" manage=off border=off

# https://github.com/koekeishiya/yabai/issues/366
# yabai -m signal --add \
#   label=keep-metamask-small \
#   event=window_created \
#   app='^Google Chrome$' \
#   title='^MetaMask Notification$' \
#   action='
#     yabai -m query --windows --window $YABAI_WINDOW_ID \
#     | jq -re ".floating == 0" \
#     && yabai -m window $YABAI_WINDOW_ID --toggle float
#   '

yabai -m signal --add app='^Google Chrome$' event='window_title_changed' \
  action="yabai -m rule --add label=$(uuidgen) app='^Google Chrome$' title='MetaMask Notification' manage=off"

#
# Configuring Spaces
#
for _ in $(yabai -m query --spaces | jq '.[].index | select(. > 6)'); do
  yabai -m space --destroy 7
done

function setup_space {
  local idx="$1"
  local name="$2"
  local space=
  echo "setup space $idx : $name"

  space=$(yabai -m query --spaces --space "$idx")
  if [ -z "$space" ]; then
    yabai -m space --create
  fi

  yabai -m space "$idx" --label "$name"
}

setup_space 1 personal
setup_space 2 notes
setup_space 3 calendar
setup_space 4 ethglobal
setup_space 5 optimism
setup_space 6 other

# move some apps automatically to specific spaces
yabai -m rule --add app="^Google Chrome$" title="Liam$" space=^1
yabai -m rule --add app="^Google Chrome$" title="Liam \(ETHGlobal\)$" space=^4
yabai -m rule --add app="^Google Chrome$" title="Liam \(Optimism\)$" space=^5

yabai -m rule --add app="^Obsidian$" space=^2
yabai -m rule --add app="^Cron$" space=^3
yabai -m rule --add app="^(Telegram|Spotify|Figma|Beeper|Signal|Books|Notion)$" space=6

yabai -m config --space 6 layout stack

yabai -m signal --add event=window_created action="~/.dotfiles/yabai/refresh.sh"
yabai -m signal --add event=window_destroyed action="~/.dotfiles/yabai/refresh.sh"

echo "yabai configuration loaded.."
